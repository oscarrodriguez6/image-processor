<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Imágenes</title>
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="leaflet/leaflet.markercluster.js"></script>
	<link rel="stylesheet" href="leaflet/MarkerCluster.css">
	<link rel="stylesheet" href="leaflet/MarkerCluster.Default.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="css/styles.css">

	<style>
	     #map {
	         height: 80vh;
	         width: 100%;
	         border-radius: 10px;
	         box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
	     }
	     .map-popup img {
	         width: 150px;
	         border-radius: 5px;
	     }
	 </style>
</head>
<body>
	<div class="container-fluid mt-4" style="width: 90%">
	    <h2 class="text-center">Mapa de Imágenes</h2>
	    <div class="row">
	        <!-- Columna para el formulario -->
	        <div class="col-md-1">
				<div class="mt-3">
				    <a href="/home" class="btn btn-secondary w-100">Inicio</a>
				</div>
				<div class="mt-3">
				    <a href="/verMapa" class="btn btn-secondary w-100">Ver Mapa</a>
				</div>

	        </div>

				        <!-- Columna para la galería de imágenes -->
	        <div class="col-md-9">
				<div class="container mt-10">
				    <div id="map"></div>
				</div>

			</div>
	    </div>
		<!-- Modal para mostrar la imagen original -->
		<div class="modal fade" id="imageModal" tabindex="-1">
		    <div class="modal-dialog modal-dialog-fullscreen">
		        <div class="modal-content modal-content-fullscreen">
		            <div class="modal-body modal-body-fullscreen text-center">
		                <img id="fullImage" class="img-fluid img-fullscreen zoomable" src="" alt="Imagen Original">
		            </div>
		        </div>
		    </div>
		</div>
	</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const map = L.map('map').setView([40.5916, -4.1477], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
            
            let markers = L.markerClusterGroup();
            map.addLayer(markers);

            function cargarImagenes(bounds) {
                fetch(`/coordenadas2?minLat=${bounds.getSouth()}&maxLat=${bounds.getNorth()}&minLon=${bounds.getWest()}&maxLon=${bounds.getEast()}`)
                    .then(response => response.json())
                    .then(data => {
                        markers.clearLayers();
                        
                        data.forEach(item => {
                            if (item.hasOwnProperty('cantidad')) { // Es un cluster
                                let clusterMarker = L.marker([item.latitud, item.longitud]);
                                clusterMarker.bindPopup(`<b>${item.cantidad} imágenes en esta área</b>`);
                                markers.addLayer(clusterMarker);
                            } else { // Es una imagen individual
                                let marker = L.marker([item.latitud, item.longitud]).addTo(map);
                                marker.bindPopup(`<div class='map-popup'><img src='${item.urlMiniatura}' onclick='abrirImagen(${item.id})'></div>`);
                                markers.addLayer(marker);
                            }
                        });
                    })
                    .catch(error => console.error("Error cargando imágenes:", error));
            }
            
            map.on('moveend', function () {
                cargarImagenes(map.getBounds());
            });

            cargarImagenes(map.getBounds());
        });

		function abrirImagen(id) {
		    document.getElementById("fullImage").src = `/imagenes/original/${id}`;
		    new bootstrap.Modal(document.getElementById("imageModal")).show();
        }
    </script>
</body>
</html>
